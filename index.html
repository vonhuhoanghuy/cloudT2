<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox T∆∞ V·∫•n</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

</head>
<body>

    <div class="chat-icon" onclick="toggleChat()">
        <img src="https://static.vecteezy.com/system/resources/previews/021/495/949/original/messenger-logo-icon-free-png.png" alt="Chat">
    </div>


    <div class="chatbox" id="chatbox">
        <div class="chat-header" onclick="toggleChat()">Chat v·ªõi ch√∫ng t√¥i</div>
        <div class="chat-body" id="chat-body"></div>
        
        <!-- H·ªôp nh·∫≠p tin nh·∫Øn -->
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." oninput="showSuggestions()" onkeypress="handleUserMessage(event)">
            <button class="send-button" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        
        <!-- H·ªôp hi·ªÉn th·ªã g·ª£i √Ω -->
        <div id="suggestions-box" class="suggestions-box"></div>
    </div>
    

    <script>
        let productList = [];

        // Load danh s√°ch s·∫£n ph·∫©m t·ª´ API
        async function loadProducts() {
            try {
                let response = await fetch("http://localhost:3000/api/products");
                productList = await response.json();
            } catch (error) {
                console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", error);
            }
        }

        // X·ª≠ l√Ω tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
        function handleUserMessage(event) {
            if (event.key === "Enter") {
                let inputField = document.getElementById("chat-input");
                let userMessage = inputField.value.trim();
                if (userMessage !== "") {
                    addMessage("B·∫°n", userMessage, "user");
                    processUserMessage(userMessage);
                    inputField.value = "";
                }
            }
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn tr√™n chatbox
        function addMessage(sender, message, type = "bot") {
    let chatBody = document.getElementById("chat-body");
    let messageElement = document.createElement("div");
    
    messageElement.classList.add("message");

    if (type === "user") {
        messageElement.innerHTML = `<div class="user-message">${message}</div>`;
    } else {
        messageElement.innerHTML = `<div class="bot-message"><strong>${sender}:</strong> ${message}</div>`;
    }

    chatBody.appendChild(messageElement);
    chatBody.scrollTop = chatBody.scrollHeight;
}



        function processUserMessage(userMessage) {
    userMessage = userMessage.toLowerCase();

    // Ch√†o h·ªèi
    if (userMessage.includes("hello") || userMessage.includes("ch√†o")) {
        addMessage("Chatbot", "Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?");
        return;
    }

    // C·∫£m ∆°n
    if (userMessage.includes("c·∫£m ∆°n") || userMessage.includes("thanks")) {
        addMessage("Chatbot", "Kh√¥ng c√≥ g√¨! N·∫øu b·∫°n c·∫ßn h·ªó tr·ª£, c·ª© h·ªèi nh√©.");
        return;
    }

    // T√¨m ki·∫øm s·∫£n ph·∫©m
    let foundProducts = productList.filter(product =>
        product.name.toLowerCase().includes(userMessage)
    );

    if (foundProducts.length > 0) {
        let response = "üîç T√¥i ƒë√£ t√¨m th·∫•y m·ªôt s·ªë s·∫£n ph·∫©m ph√π h·ª£p:<br><br>";
        foundProducts.forEach(product => {
            response += `
                <div class="product" id="product-${product._id}">
                    <b>üåü ${product.name}</b>
                    <button onclick="toggleProductDetails('${product._id}')">Xem chi ti·∫øt</button>
                    <div class="product-details" id="details-${product._id}" style="display: none;">
                        üí∞ Gi√°: ${product.price} VND<br>
                        üî• Gi√° KM: ${product.promotionPrice} VND<br>
                        üìù ${product.description}<br>
                        üì¶ S·ªë l∆∞·ª£ng: ${product.quantityInStock}<br>
                        <img src="http://localhost:3000/images/${product.image}" width="150">
                    </div>
                </div>
                <hr>
            `;
        });
        addMessage("Chatbot", response);
    } else {
        addMessage("Chatbot", "‚ùå Xin l·ªói, t√¥i kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p.");
    }
}


        // Xem chi ti·∫øt s·∫£n ph·∫©m
        function viewProduct(productId) {
            let product = productList.find(p => p._id === productId);
            if (product) {
                let detail = `
                    <b>üîç Chi ti·∫øt s·∫£n ph·∫©m:</b><br>
                    üåü <b>${product.name}</b><br>
                    üí∞ Gi√°: ${product.price} VND<br>
                    üî• Gi√° KM: ${product.promotionPrice} VND<br>
                    üìù ${product.description}<br>
                    üì¶ S·ªë l∆∞·ª£ng: ${product.quantityInStock}<br>
                    <img src="http://localhost:3000/images/${product.image}" width="150">
                `;
                addMessage("Chatbot", detail);
            }
        }

        // ·∫®n / Hi·ªán chatbox
        function toggleChat() {
            let chatbox = document.getElementById("chatbox");
            let chatIcon = document.querySelector(".chat-icon");
            chatbox.style.display = chatbox.style.display === "block" ? "none" : "block";
            chatIcon.style.display = chatbox.style.display === "block" ? "none" : "flex";
        }

        function toggleProductDetails(productId) {
         let detailsDiv = document.getElementById(`details-${productId}`);
        if (detailsDiv.style.display === "none") {
            detailsDiv.style.display = "block";
        } else {
        detailsDiv.style.display = "none";
    }
}


        loadProducts();

        // G·ª£i √Ω chat
        function showSuggestions() {
    let input = document.getElementById("chat-input").value.toLowerCase();
    let suggestionsBox = document.getElementById("suggestions-box");

    if (input.length < 2) {
        suggestionsBox.style.display = "none"; // ·∫®n n·∫øu nh·∫≠p qu√° √≠t k√Ω t·ª±
        return;
    }

    // L·ªçc danh s√°ch s·∫£n ph·∫©m theo k√Ω t·ª± nh·∫≠p v√†o
    let suggestions = productList.filter(product =>
        product.name.toLowerCase().includes(input)
    );

    // Hi·ªÉn th·ªã danh s√°ch g·ª£i √Ω
    if (suggestions.length > 0) {
        let suggestionHTML = suggestions.map(product =>
            `<div class="suggestion-item" onclick="selectSuggestion('${product.name}')">${product.name}</div>`
        ).join("");
        suggestionsBox.innerHTML = suggestionHTML;
        suggestionsBox.style.display = "block";
    } else {
        suggestionsBox.style.display = "none";
    }
}

// Khi nh·∫•n v√†o g·ª£i √Ω, ƒëi·ªÅn v√†o √¥ nh·∫≠p v√† g·ª≠i tin nh·∫Øn
function selectSuggestion(productName) {
    document.getElementById("chat-input").value = productName;
    document.getElementById("suggestions-box").style.display = "none"; // ·∫®n g·ª£i √Ω
}

// Khi ng∆∞·ªùi d√πng g·ª≠i tin nh·∫Øn
function sendMessage() {
    let inputField = document.getElementById("chat-input");
    let userMessage = inputField.value.trim();
    
    if (userMessage !== "") {
        addMessage("B·∫°n", userMessage, "user");
        processUserMessage(userMessage);
        inputField.value = "";
        document.getElementById("suggestions-box").style.display = "none"; // ·∫®n g·ª£i √Ω khi g·ª≠i tin nh·∫Øn
    }
}

    </script>

</body>
</html>
